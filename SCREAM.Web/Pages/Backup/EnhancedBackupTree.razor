@using SCREAM.Data.Entities.BackupItems
@using Microsoft.AspNetCore.Components.Web.Virtualization

<MudPaper Elevation="3" Class="pa-4 mb-4 rounded-lg">
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h6" Class="mb-2">Select Backup Items</MudText>
        </MudItem>
        <MudItem xs="12" md="7">
            <MudText Typo="Typo.body2" Class="mb-3">
                Select the database objects you want to include in your backup plan
            </MudText>
        </MudItem>
        <MudItem xs="12" md="5">
            <div class="d-flex justify-end">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           Size="Size.Small"
                           OnClick="() => ToggleAllItems(true)"
                           Class="mr-2"
                           Disabled="@_isLoading"
                           StartIcon="@Icons.Material.Filled.CheckBox">
                    Select All
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Primary"
                           Size="Size.Small"
                           OnClick="() => ToggleAllItems(false)"
                           Disabled="@_isLoading"
                           StartIcon="@Icons.Material.Filled.DisabledByDefault">
                    Unselect All
                </MudButton>
            </div>
        </MudItem>
    </MudGrid>

    <MudDivider Class="my-3"/>

    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle1" Class="mb-2">Quick Selection Options</MudText>
        </MudItem>
        <MudItem xs="12">
            <div class="d-flex flex-wrap gap-2">
                @foreach (var option in _quickSelectOptions)
                {
                    <MudButton Variant="Variant.Outlined"
                               Color="@option.Color"
                               Size="Size.Small"
                               OnClick="() => SelectItemsByType(option.Type)"
                               Disabled="@_isLoading"
                               StartIcon="@GetIconForBackupItemType(option.Type)">
                        @option.Label
                    </MudButton>
                }
            </div>
        </MudItem>
    </MudGrid>

    @if (Items.Any())
    {
        <MudDivider Class="my-3"/>
        <MudChip T="string" Color="Color.Primary" Size="Size.Small" Class="mt-2 mb-4">
            Selected: @Items.Count(i => i.IsSelected) / @Items.Count total items
        </MudChip>
    }
</MudPaper>

@if (_isLoading)
{
    <MudPaper Elevation="0" Class="pa-6 d-flex flex-column align-center">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" Class="mb-4"/>
        <MudText Align="Align.Center">Scanning database and organizing items...</MudText>
    </MudPaper>
}
else if (!_schemaGroups.Any())
{
    <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="my-4">
        <MudText>No backup items available. Try scanning the database again.</MudText>
    </MudAlert>
}
else
{
    <div class="d-flex align-center mb-4">
        <MudSelect T="string" Label="Filter by schema"
                   Value="_selectedSchemaFilter"
                   ValueChanged="FilterBySchema"
                   Class="mr-4">
            <MudSelectItem Value="@("all")">All Schemas</MudSelectItem>
            @foreach (var schema in _schemaGroups)
            {
                <MudSelectItem Value="@schema.SchemaName">@schema.SchemaName</MudSelectItem>
            }
        </MudSelect>

        <MudSelect T="string" Label="Filter by type"
                   Value="_selectedTypeFilter"
                   ValueChanged="FilterByTypeString"
                   Clearable="true">
            <MudSelectItem Value="@("all")">All Types</MudSelectItem>
            @foreach (var option in _quickSelectOptions)
            {
                <MudSelectItem Value="@option.Type.ToString()">@option.Label</MudSelectItem>
            }
        </MudSelect>
    </div>

    <MudTable T="SchemaGroup"
              Items="@_filteredSchemaGroups"
              Dense="true"
              Hover="true"
              Breakpoint="Breakpoint.Sm"
              LoadingProgressColor="Color.Primary"
              RowsPerPage="5">
        <HeaderContent>
            <MudTh>Schema</MudTh>
            <MudTh>Selected</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Schema">
                <div class="d-flex align-center" @onclick="() => ToggleSchema(context)">
                    <MudIcon
                        Icon="@(context.IsExpanded ? Icons.Material.Filled.ExpandMore : Icons.Material.Filled.ChevronRight)"
                        Size="Size.Small" Class="mr-2"/>
                    <MudText Typo="Typo.body1">@context.SchemaName</MudText>
                </div>
            </MudTd>
            <MudTd DataLabel="Selected">
                <MudChip T="string" Color="Color.Default" Size="Size.Small" Label="true">
                    @context.Items.Count(i => i.IsSelected)/@context.Items.Count
                </MudChip>
            </MudTd>
            <MudTd>
                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense="true" AnchorOrigin="Origin.BottomRight">
                    <MudMenuItem OnClick="() => ToggleSchemaSelection(context, true)">Select All</MudMenuItem>
                    <MudDivider />
                    @foreach (var option in _quickSelectOptions)
                    {
                        <MudMenuItem OnClick="() => SelectSchemaItemsByType(context, option.Type)">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@GetIconForBackupItemType(option.Type)" 
                                        Size="Size.Small" 
                                        Class="mr-2" 
                                        Color="@option.Color" />
                                @option.Label.Replace("Select All ", "")
                            </div>
                        </MudMenuItem>
                    }
                    <MudDivider />
                    <MudMenuItem OnClick="() => ToggleSchemaSelection(context, false)">Unselect All</MudMenuItem>
                </MudMenu>
            </MudTd>
        </RowTemplate>
        <ChildRowContent>
            @if (context.IsExpanded)
            {
                <MudTr>
                    <td colspan="3" style="padding: 0">
                        @if (context.SchemaItems.Any())
                        {
                            <MudPaper Elevation="0" Class="ma-2 pa-2"
                                      Style="border: 1px solid var(--mud-palette-lines-default); border-radius: 4px;">
                                <div class="d-flex align-center justify-space-between mb-2">
                                    <MudText Typo="Typo.subtitle2">Schema-Level Objects</MudText>
                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense="true" AnchorOrigin="Origin.BottomRight">
                                        @foreach (var option in _quickSelectOptions)
                                        {
                                            @if (context.SchemaItems.Any(i => i.Type == option.Type))
                                            {
                                                <MudMenuItem OnClick="() => SelectSchemaLevelItemsByType(context, option.Type)">
                                                    <div class="d-flex align-center">
                                                        <MudIcon Icon="@GetIconForBackupItemType(option.Type)" 
                                                                Size="Size.Small" 
                                                                Class="mr-2" 
                                                                Color="@option.Color" />
                                                        @option.Label.Replace("Select All ", "")
                                                    </div>
                                                </MudMenuItem>
                                            }
                                        }
                                    </MudMenu>
                                </div>
                                <div class="d-flex flex-wrap">
                                    @foreach (var item in context.SchemaItems)
                                    {
                                        <div class="pa-1 ma-1 d-flex align-center" style="min-width: 200px">
                                            <MudCheckBox T="bool"
                                                         Value="@item.IsSelected"
                                                         ValueChanged="@(value => OnItemSelectionChanged(item, context, null, value))"
                                                         Color="Color.Primary"/>
                                            <MudIcon Icon="@GetIconForBackupItemType(item.Type)"
                                                     Size="Size.Small"
                                                     Class="mx-1"
                                                     Color="@GetColorForBackupItemType(item.Type)"/>
                                            <MudText Typo="Typo.body2">@GetBackupItemTypeLabel(item.Type)</MudText>
                                        </div>
                                    }
                                </div>
                            </MudPaper>
                        }
                        <MudDivider/>

                        <MudContainer Class="pa-2">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Tables and Views</MudText>

                            @if (context.Tables.Count > 10)
                            {
                                <div class="mb-2">
                                    <MudTextField T="string"
                                                  Value="@_tableSearchString"
                                                  ValueChanged="@(s => FilterTables(context, s))"
                                                  Placeholder="Search tables..."
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                                  Immediate="true"
                                                  Class="mt-0"/>
                                </div>
                            }

                            <Virtualize Items="@_filteredTables.GetValueOrDefault(context.SchemaName, context.Tables)"
                                        Context="table">
                                <div class="mb-2 pa-2"
                                     style="border: 1px solid var(--mud-palette-lines-default); border-radius: 4px;">
                                    <div class="d-flex align-center justify-space-between">
                                        <div class="d-flex align-center">
                                            <MudCheckBox T="bool"
                                                         Value="@table.IsFullySelected"
                                                         ValueChanged="@(value => ToggleTableSelection(table, context, value))"
                                                         Color="Color.Primary"/>
                                            <MudText Typo="Typo.body2" Class="ml-2">@table.TableName</MudText>
                                        </div>
                                        <div class="d-flex align-center">
                                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense="true" AnchorOrigin="Origin.BottomRight">
                                                <MudMenuItem OnClick="() => ToggleTableSelection(table, context, true)">Select All</MudMenuItem>
                                                <MudDivider />
                                                @foreach (var option in _quickSelectOptions)
                                                {
                                                    @if (table.Items.Any(i => i.Type == option.Type))
                                                    {
                                                        <MudMenuItem OnClick="() => SelectTableItemsByType(table, context, option.Type)">
                                                            <div class="d-flex align-center">
                                                                <MudIcon Icon="@GetIconForBackupItemType(option.Type)" 
                                                                        Size="Size.Small" 
                                                                        Class="mr-2" 
                                                                        Color="@option.Color" />
                                                                @option.Label.Replace("Select All ", "")
                                                            </div>
                                                        </MudMenuItem>
                                                    }
                                                }
                                                <MudDivider />
                                                <MudMenuItem OnClick="() => ToggleTableSelection(table, context, false)">Unselect All</MudMenuItem>
                                            </MudMenu>
                                            <MudIconButton
                                                Icon="@(table.IsExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                                Size="Size.Small"
                                                OnClick="() => ToggleTable(table)"/>
                                        </div>
                                    </div>

                                    @if (table.IsExpanded)
                                    {
                                        <div class="mt-2 ml-6">
                                            @foreach (var item in table.Items)
                                            {
                                                <div class="d-flex align-center mb-1">
                                                    <MudCheckBox T="bool"
                                                                 Value="@item.IsSelected"
                                                                 ValueChanged="@(value => OnItemSelectionChanged(item, context, table, value))"
                                                                 Color="Color.Primary"
                                                                 Size="Size.Small"/>
                                                    <MudIcon Icon="@GetIconForBackupItemType(item.Type)"
                                                             Size="Size.Small"
                                                             Class="mx-1"
                                                             Color="@GetColorForBackupItemType(item.Type)"/>
                                                    <MudText
                                                        Typo="Typo.body2">@GetBackupItemTypeLabel(item.Type)</MudText>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </Virtualize>
                        </MudContainer>
                    </td>
                </MudTr>
            }
        </ChildRowContent>
        <PagerContent>
            <MudTablePager/>
        </PagerContent>
    </MudTable>
}

@code {
    [Parameter] public List<BackupItem> Items { get; set; } = new();
    [Parameter] public EventCallback<List<BackupItem>> ItemsChanged { get; set; }

    private List<SchemaGroup> _schemaGroups = new();
    private List<SchemaGroup> _filteredSchemaGroups = new();
    private Dictionary<string, List<TableGroup>> _filteredTables = new();
    private bool _isLoading = false;
    private string _selectedSchemaFilter = "all";
    private string _selectedTypeFilter = "all";
    private string _tableSearchString = "";

    private class QuickSelectOption
    {
        public BackupItemType Type { get; set; }
        public string Label { get; set; }
        public Color Color { get; set; }
    }

    private readonly List<QuickSelectOption> _quickSelectOptions = new()
    {
        new QuickSelectOption { Type = BackupItemType.TableStructure, Label = "Select All Structure", Color = Color.Primary },
        new QuickSelectOption { Type = BackupItemType.TableData, Label = "Select All Data", Color = Color.Secondary },
        new QuickSelectOption { Type = BackupItemType.View, Label = "Select All Views", Color = Color.Tertiary },
        new QuickSelectOption { Type = BackupItemType.Trigger, Label = "Select All Triggers", Color = Color.Info },
        new QuickSelectOption { Type = BackupItemType.Event, Label = "Select All Events", Color = Color.Success },
        new QuickSelectOption { Type = BackupItemType.FunctionProcedure, Label = "Select All Functions/Procedures", Color = Color.Warning }
    };

    protected override void OnParametersSet()
    {
        if (Items.Any())
        {
            _isLoading = true;
            StateHasChanged();
            try
            {
                GroupItemsBySchema();
                ApplyFilters();
            }
            finally
            {
                _isLoading = false;
                StateHasChanged();
            }
        }
    }

    private void GroupItemsBySchema()
    {
        var existingSchemas = _schemaGroups.ToDictionary(s => s.SchemaName);
        var newSchemaGroups = new List<SchemaGroup>();

        var schemaGroups = Items
            .GroupBy(i => i.Schema)
            .OrderBy(g => g.Key)
            .ToList();

        foreach (var schemaGroup in schemaGroups)
        {
            var schemaName = schemaGroup.Key;
            var existingSchema = existingSchemas.GetValueOrDefault(schemaName);

            var schema = existingSchema ?? new SchemaGroup();
            schema.SchemaName = schemaName;
            schema.Items = schemaGroup.ToList();

            // Separate schema-level items
            schema.SchemaItems = schema.Items
                .Where(i => string.IsNullOrEmpty(i.Name))
                .ToList();

            // Preserve existing expansion state or default to false
            schema.IsExpanded = existingSchema?.IsExpanded ?? false;

            // Process tables
            var existingTables = schema.Tables.ToDictionary(t => t.TableName);
            schema.Tables.Clear();

            var tableItems = schemaGroup
                .Where(i => !string.IsNullOrEmpty(i.Name))
                .ToList();

            foreach (var tableGroup in tableItems
                         .GroupBy(i => i.Name)
                         .OrderBy(g => g.Key))
            {
                var tableName = tableGroup.Key!;
                var existingTable = existingTables.GetValueOrDefault(tableName);

                var table = existingTable ?? new TableGroup();
                table.TableName = tableName;
                table.Items = tableGroup.ToList();
                table.IsExpanded = existingTable?.IsExpanded ?? false;

                schema.Tables.Add(table);
                UpdateTableSelectionState(table);
            }

            UpdateSchemaSelectionState(schema);
            newSchemaGroups.Add(schema);
        }

        _schemaGroups = newSchemaGroups;
    }

    private void ApplyFilters()
    {
        _filteredSchemaGroups = _schemaGroups;

        // Filter by schema
        if (_selectedSchemaFilter != "all")
        {
            _filteredSchemaGroups = _schemaGroups
                .Where(s => s.SchemaName == _selectedSchemaFilter)
                .ToList();
        }

        // Apply type filter if selected
        if (_selectedTypeFilter != "all")
        {
            if (Enum.TryParse<BackupItemType>(_selectedTypeFilter, out var typeFilter))
            {
                foreach (var schema in _filteredSchemaGroups)
                {
                    var filteredTables = schema.Tables
                        .Where(t => t.Items.Any(i => i.Type == typeFilter))
                        .ToList();

                    if (!_filteredTables.ContainsKey(schema.SchemaName))
                    {
                        _filteredTables[schema.SchemaName] = filteredTables;
                    }
                }
            }
        }
        else
        {
            _filteredTables.Clear();
        }
    }

    private void FilterBySchema(string schemaName)
    {
        _selectedSchemaFilter = schemaName;
        ApplyFilters();
        StateHasChanged();
    }

    private void FilterByTypeString(string typeString)
    {
        _selectedTypeFilter = typeString;
        ApplyFilters();
        StateHasChanged();
    }

    private void FilterTables(SchemaGroup schema, string searchString)
    {
        _tableSearchString = searchString;

        if (string.IsNullOrWhiteSpace(searchString))
        {
            if (_filteredTables.ContainsKey(schema.SchemaName))
            {
                _filteredTables.Remove(schema.SchemaName);
            }
        }
        else
        {
            _filteredTables[schema.SchemaName] = schema.Tables
                .Where(t => t.TableName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        StateHasChanged();
    }

    private void ToggleSchema(SchemaGroup schema)
    {
        schema.IsExpanded = !schema.IsExpanded;
    }

    private void ToggleTable(TableGroup table)
    {
        table.IsExpanded = !table.IsExpanded;
    }

    private void UpdateTableSelectionState(TableGroup table)
    {
        table.IsFullySelected = table.Items.Any(i => i.IsSelected);
    }

    private void UpdateSchemaSelectionState(SchemaGroup schema)
    {
        schema.IsFullySelected = schema.Items.Any(i => i.IsSelected);
    }

    private async Task ToggleSchemaSelection(SchemaGroup schema, bool isSelected)
    {
        foreach (var item in schema.Items)
        {
            item.IsSelected = isSelected;
        }

        foreach (var table in schema.Tables)
        {
            UpdateTableSelectionState(table);
        }

        UpdateSchemaSelectionState(schema);
        await NotifyItemsChanged();
    }

    private async Task ToggleTableSelection(TableGroup table, SchemaGroup schema, bool isSelected)
    {
        foreach (var item in table.Items)
        {
            item.IsSelected = isSelected;
        }

        UpdateTableSelectionState(table);
        UpdateSchemaSelectionState(schema);
        await NotifyItemsChanged();
    }

    private async Task OnItemSelectionChanged(BackupItem item, SchemaGroup schema, TableGroup table, bool isSelected)
    {
        item.IsSelected = isSelected;
        if (table != null)
        {
            UpdateTableSelectionState(table);
        }

        UpdateSchemaSelectionState(schema);
        await NotifyItemsChanged();
    }

    private async Task ToggleAllItems(bool isSelected)
    {
        foreach (var item in Items)
        {
            item.IsSelected = isSelected;
        }

        foreach (var schema in _schemaGroups)
        {
            UpdateSchemaSelectionState(schema);
            foreach (var table in schema.Tables)
            {
                UpdateTableSelectionState(table);
            }
        }

        await NotifyItemsChanged();
    }

    private async Task SelectItemsByType(BackupItemType type)
    {
        foreach (var item in Items)
        {
            if (item.Type == type)
            {
                item.IsSelected = true;
            }
        }

        foreach (var schema in _schemaGroups)
        {
            UpdateSchemaSelectionState(schema);
            foreach (var table in schema.Tables)
            {
                UpdateTableSelectionState(table);
            }
        }

        await NotifyItemsChanged();
    }

    private async Task SelectSchemaItemsByType(SchemaGroup schema, BackupItemType type)
    {
        foreach (var item in schema.Items)
        {
            if (item.Type == type)
            {
                item.IsSelected = true;
            }
        }

        foreach (var table in schema.Tables)
        {
            UpdateTableSelectionState(table);
        }

        UpdateSchemaSelectionState(schema);
        await NotifyItemsChanged();
    }

    private async Task SelectSchemaLevelItemsByType(SchemaGroup schema, BackupItemType type)
    {
        foreach (var item in schema.SchemaItems)
        {
            if (item.Type == type)
            {
                item.IsSelected = true;
            }
        }

        UpdateSchemaSelectionState(schema);
        await NotifyItemsChanged();
    }

    private async Task SelectTableItemsByType(TableGroup table, SchemaGroup schema, BackupItemType type)
    {
        foreach (var item in table.Items)
        {
            if (item.Type == type)
            {
                item.IsSelected = true;
            }
        }
        
        UpdateTableSelectionState(table);
        UpdateSchemaSelectionState(schema);
        await NotifyItemsChanged();
    }

    private async Task NotifyItemsChanged()
    {
        if (ItemsChanged.HasDelegate)
        {
            await ItemsChanged.InvokeAsync(Items);
        }
    }

    private string GetBackupItemTypeLabel(BackupItemType type)
    {
        return type switch
        {
            BackupItemType.TableStructure => "Structure",
            BackupItemType.TableData => "Data",
            BackupItemType.View => "View",
            BackupItemType.Trigger => "Triggers",
            BackupItemType.Event => "Events",
            BackupItemType.FunctionProcedure => "Functions/Procedures",
            _ => type.ToString()
        };
    }

    private string GetIconForBackupItemType(BackupItemType type)
    {
        return type switch
        {
            BackupItemType.TableStructure => Icons.Material.Filled.Schema,
            BackupItemType.TableData => Icons.Material.Filled.Storage,
            BackupItemType.View => Icons.Material.Filled.TableView,
            BackupItemType.Trigger => Icons.Material.Filled.Bolt,
            BackupItemType.Event => Icons.Material.Filled.Event,
            BackupItemType.FunctionProcedure => Icons.Material.Filled.Code,
            _ => Icons.Material.Filled.Backup
        };
    }

    private Color GetColorForBackupItemType(BackupItemType type)
    {
        return type switch
        {
            BackupItemType.TableStructure => Color.Primary,
            BackupItemType.TableData => Color.Secondary,
            BackupItemType.View => Color.Tertiary,
            BackupItemType.Trigger => Color.Info,
            BackupItemType.Event => Color.Success,
            BackupItemType.FunctionProcedure => Color.Warning,
            _ => Color.Default
        };
    }

    private class SchemaGroup
    {
        public string SchemaName { get; set; } = string.Empty;
        public List<BackupItem> Items { get; set; } = new();
        public List<BackupItem> SchemaItems { get; set; } = new();
        public List<TableGroup> Tables { get; set; } = new();
        public bool IsFullySelected { get; set; }
        public bool IsExpanded { get; set; }
    }

    private class TableGroup
    {
        public string TableName { get; set; } = string.Empty;
        public List<BackupItem> Items { get; set; } = new();
        public bool IsFullySelected { get; set; }
        public bool IsExpanded { get; set; }
    }
}